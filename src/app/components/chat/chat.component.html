<div class="chat-widget" [class.open]="isOpen" [class.full-screen]="isFullScreen">
  <div class="chat-header" (click)="toggleChat()">
    <div class="d-flex align-items-center">
      <i-tabler name="message-circle" class="icon-24 m-r-8"></i-tabler>
      <span class="f-w-600">Asistente Virtual</span>
    </div>
    <i-tabler *ngIf="!isFullScreen" [name]="isOpen ? 'chevron-down' : 'chevron-up'" class="icon-20"></i-tabler>
  </div>

  <div class="chat-body" *ngIf="isOpen">
    <div class="messages-list">
      <div class="message-item" *ngFor="let msg of messages" [ngClass]="{'user-message': msg.sender === 'user', 'bot-message': msg.sender === 'bot'}">
        
        <!-- Text Content -->
        <div class="message-content" *ngIf="msg.text" [innerHTML]="formatMessage(msg.text)"></div>
        
        <!-- Botón de descarga JSON (solo para mensajes del bot con apiResponse) -->
        <!-- <button *ngIf="msg.sender === 'bot' && msg.apiResponse" 
                mat-icon-button 
                class="download-json-btn" 
                (click)="downloadJSON(msg)"
                matTooltip="Descargar análisis en JSON">
          <i-tabler name="file-type-json" class="icon-18"></i-tabler>
        </button> -->

        <!-- Attachment Content -->
        <div class="message-attachments" *ngIf="msg.attachments && msg.attachments.length > 0">
           <div class="attachment-item" *ngFor="let attachment of msg.attachments">
              <!-- Image Preview -->
              <div *ngIf="attachment.type === 'image' && attachment.url" class="image-attachment" (click)="openImagePreview(attachment.url)">
                <img [src]="attachment.url" [alt]="attachment.name" style="width: 250px; height: 250px;">
                <div class="image-overlay">
                  <i-tabler name="zoom-in" class="icon-20"></i-tabler>
                </div>
              </div>

              <!-- File Preview (PDF/Excel) -->
              <div *ngIf="attachment.type !== 'image'" class="file-attachment" [ngClass]="attachment.type">
                <div class="file-icon">
                  <i-tabler *ngIf="attachment.type === 'pdf'" name="file-type-pdf" class="icon-24"></i-tabler>
                  <i-tabler *ngIf="attachment.type === 'excel'" name="file-spreadsheet" class="icon-24"></i-tabler>
                </div>
                <div class="file-info">
                  <span class="file-name">{{ attachment.name }}</span>
                  <span class="file-type">{{ attachment.type | uppercase }}</span>
                </div>
              </div>
           </div>
        </div>

        <div class="message-time">
          {{ msg.time | date:'shortTime' }}
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div class="message-item bot-message" *ngIf="isProcessing">
        <div class="message-content typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-footer" *ngIf="isOpen">
    
    <!-- Hidden File Input -->
    <input type="file" #fileInput hidden (change)="onFileSelected($event)" [accept]="getAcceptTypes()" multiple>
    
    <!-- Attachment Menu -->
    <div class="attachment-menu" [class.show]="showAttachments">
      <button mat-mini-fab class="attach-btn pdf" (click)="handleFileUpload('pdf')" matTooltip="Subir PDF">
        <i-tabler name="file-type-pdf" class="icon-20"></i-tabler>
      </button>
      <button mat-mini-fab class="attach-btn excel" (click)="handleFileUpload('excel')" matTooltip="Subir Excel">
        <i-tabler name="file-spreadsheet" class="icon-20"></i-tabler>
      </button>
      <button mat-mini-fab class="attach-btn image" (click)="handleFileUpload('image')" matTooltip="Subir Imagen">
        <i-tabler name="photo" class="icon-20"></i-tabler>
      </button>
    </div>

    <!-- Attachment Preview Pending -->
    <div class="attachment-preview-pending" *ngIf="pendingAttachments.length > 0">
      <div class="preview-item" *ngFor="let attachment of pendingAttachments; let i = index">
        <div class="d-flex align-items-center gap-2">
            <span class="preview-icon">
              <i-tabler *ngIf="attachment.type === 'pdf'" name="file-type-pdf" class="icon-24"></i-tabler>
              <i-tabler *ngIf="attachment.type === 'excel'" name="file-spreadsheet" class="icon-24"></i-tabler>
              <img *ngIf="attachment.type === 'image'" [src]="attachment.url" class="rounded" width="30" height="30">
            </span>
            <span class="text-truncate" style="max-width: 150px; font-size: 12px;">{{ attachment.name }}</span>
        </div>
        <button mat-icon-button (click)="removePendingAttachment(i)" class="close-preview">
          <i-tabler name="x" class="icon-16"></i-tabler>
        </button>
      </div>
    </div>

    <div class="d-flex align-items-center w-100 gap-2">
      <button mat-icon-button (click)="toggleAttachments()" [class.active]="showAttachments" class="toggle-attach-btn">
        <i-tabler [name]="showAttachments ? 'x' : 'paperclip'" class="icon-20"></i-tabler>
      </button>
      
      <mat-form-field appearance="outline" class="w-100 no-bottom-space">
        <input matInput placeholder="Escribe un mensaje..." [(ngModel)]="newMessage" (keyup.enter)="sendMessage()">
        <button mat-icon-button matSuffix (click)="sendMessage()" color="primary">
          <i-tabler name="send" class="icon-20"></i-tabler>
        </button>
      </mat-form-field>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="image-preview-modal" *ngIf="showImagePreview" (click)="closeImagePreview()">
  <div class="modal-content">
    <button mat-icon-button class="close-btn" (click)="closeImagePreview()">
      <i-tabler name="x" class="icon-24"></i-tabler>
    </button>
    <img [src]="previewImageUrl" alt="Vista previa">
  </div>
</div>
